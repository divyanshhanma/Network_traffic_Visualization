<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Traffic Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 20px;
        }
        .chart-container {
            display: flex;
            justify-content: space-around;
            flex-direction: column; /* Arrange charts vertically */
            margin: 20px 0;
        }
        canvas {
            width: 100% !important; /* Ensures canvas fills the container */
            height: auto; /* Allow height to be set dynamically */
            margin: 10px 0; /* Adds space between charts */
        }
        button {
            margin-bottom: 20px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        /* Additional class for the smaller pie chart */
        .pie-chart-container {
            display: flex;
            justify-content: center; /* Center the pie chart */
            margin: 10px 0;
            width: 100%; /* Full width */
        }
        #protocolChart {
            max-height: 400px; /* Adjusted max height for pie chart */
            max-width: 400px; /* Adjusted max width for pie chart */
            width: 40%; /* Set a width for the pie chart */
            height: 40%; /* Set a height for the pie chart */
        }
    </style>
</head>
<body>
    <h1>Network Traffic Visualization</h1>

    <button id="fetchDataButton">Fetch Data</button>

    <div class="chart-container">
        <!-- Line chart for packet lengths -->
        <canvas id="packetLengthChart"></canvas>

        <!-- Pie chart for protocol distribution -->
        <div class="pie-chart-container">
            <canvas id="protocolChart"></canvas>
        </div>

        <!-- Line chart for throughput -->
        <canvas id="throughputChart"></canvas>
    </div>

    <script>
        async function fetchData() {
            const response = await fetch('/api/capture');
            const data = await response.json();
            return data;
        }

        // Function to format time in IST
        function formatTimeInIST(utcTime) {
            const date = new Date(utcTime * 1000); // Convert seconds to milliseconds
            
            // Check if the date is valid
            if (isNaN(date.getTime())) {
                console.error('Invalid Date for UTC Time:', utcTime);
                return 'Invalid Date'; // Return an invalid date string
            }

            const options = {
                timeZone: 'Asia/Kolkata',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            };

            // Format date to dd/mm/yyyy hh:mm:ss
            return date.toLocaleString('en-IN', options).replace(/(\d+)\/(\d+)\/(\d+),/, '$3/$2/$1') + ' ' + date.toLocaleTimeString('en-IN', { timeZone: 'Asia/Kolkata' });
        }

        async function initializeCharts() {
            try {
                const data = await fetchData();
                
                // Check for errors in the response
                if (data.error) {
                    document.getElementById('packetLengthChart').parentElement.innerHTML = data.error;
                    return;
                }

                // Format time for charts
                const formattedTimes = data.time.map(formatTimeInIST);

                // Log the formatted times to check for errors
                console.log('Formatted Times:', formattedTimes); // Debugging output

                plotPacketLength(formattedTimes, data.length);
                plotProtocolDistribution(data);
                plotThroughput(formattedTimes, data.throughput);
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('packetLengthChart').parentElement.innerHTML = 'Error fetching data.';
            }
        }

        // Function to plot packet lengths
        function plotPacketLength(formattedTimes, lengths) {
            const ctx = document.getElementById('packetLengthChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: formattedTimes,
                    datasets: [{
                        label: 'Packet Length',
                        data: lengths,
                        borderColor: 'blue',
                        fill: false
                    }]
                },
                options: {
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time (IST)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Packet Length (Bytes)'
                            }
                        }
                    }
                }
            });
        }

        // Function to plot protocol distribution
        function plotProtocolDistribution(data) {
            const protocolCounts = {};
            data.protocol.forEach(protocol => {
                protocolCounts[protocol] = (protocolCounts[protocol] || 0) + 1;
            });

            const ctx = document.getElementById('protocolChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(protocolCounts),
                    datasets: [{
                        label: 'Protocol Distribution',
                        data: Object.values(protocolCounts),
                        backgroundColor: ['red', 'green', 'blue', 'yellow', 'orange', 'purple']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Allow for custom height
                }
            });
        }

        // Function to plot network throughput
        // Function to plot network throughput
function plotThroughput(formattedTimes, throughput) {
    console.log('Throughput data:', throughput);  // Debugging output to check if throughput data is received

    const ctx = document.getElementById('throughputChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: formattedTimes.slice(1), // Use all but the first time entry
            datasets: [{
                label: 'Throughput (Bytes/sec)',
                data: throughput.slice(1),  // Match length with labels
                borderColor: 'red',
                fill: false
            }]
        },
        options: {
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Time (IST)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Throughput (Bytes/sec)'
                    }
                }
            }
        }
    });
}


        // Attach event listener to fetch data button
        document.getElementById('fetchDataButton').addEventListener('click', initializeCharts);

        // Set the height of the charts dynamically based on the viewport height
        function setChartDimensions() {
            const height = window.innerHeight * 0.3; // Adjust this ratio as needed
            const canvases = document.querySelectorAll('canvas');
            canvases.forEach(canvas => {
                canvas.height = height; // Set height to 30% of the viewport height
            });
        }

        // Call setChartDimensions on load and resize
        window.addEventListener('load', setChartDimensions);
        window.addEventListener('resize', setChartDimensions);
    </script>
</body>
</html>
